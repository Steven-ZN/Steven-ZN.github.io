<meta charset="utf-8">

{% if site.seo_title %}
  <title>{{ site.seo_title }}</title>
{% elsif page.title %}
  <title>{{ page.title }} - {{ site.title }}</title>
{% else %}
  <title>{{ site.title }}</title>
{% endif %}

<meta name="description" content="{{ page.excerpt | default: site.description | strip_html | normalize_whitespace | truncate: 160 | escape }}">

<meta name="author" content="{{ site.author.name | default: site.author }}">

<meta property="og:type" content="{% if page.layout == 'post' %}article{% else %}website{% endif %}">
<meta property="og:locale" content="{{ site.locale | replace: '-', '_' | default: 'en_US' }}">
<meta property="og:site_name" content="{{ site.title }}">
<meta property="og:title" content="{% if page.title %}{{ page.title }}{% else %}{{ site.title }}{% endif %}">
<meta property="og:url" content="{{ canonical_url }}">

{% if site.social.name %}
  <meta property="og:image" content="{% if page.header.image %}{{ page.header.image | absolute_url }}{% else %}{{ site.og_image | absolute_url }}{% endif %}">
{% endif %}

{% if page.date %}
  <meta property="article:published_time" content="{{ page.date | date_to_xmlschema }}">
{% endif %}

{% if og_image %}
  <meta property="og:image" content="{{ og_image }}">
{% endif %}

{% if page.excerpt %}
  <meta property="og:description" content="{{ page.excerpt | strip_html | normalize_whitespace | truncate: 160 | escape }}">
{% endif %}

<!-- Font Awesome Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="{{ '/images/favicon.svg' | relative_url }}">
<link rel="shortcut icon" href="{{ '/images/favicon.svg' | relative_url }}">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

{% seo %}

<link href="{% if jekyll.environment == 'production' %}{{ '/assets/css/main.css' | absolute_url }}{% else %}{{ '/assets/css/main.css' | relative_url }}{% endif %}" rel="stylesheet">

<!-- Dark Mode Toggle Button -->
<div class="dark-mode-toggle" onclick="toggleDarkMode()">
  <i class="fas fa-sun toggle-icon sun" id="sun-icon"></i>
  <i class="fas fa-moon toggle-icon moon" id="moon-icon" style="display: none;"></i>
</div>

<!-- Dark Mode JavaScript -->
<script>
// Check for saved theme preference or default to light mode
const currentTheme = localStorage.getItem('theme') || 'light';
document.documentElement.setAttribute('data-theme', currentTheme);

// Update toggle button display
function updateToggleButton() {
  const sunIcon = document.getElementById('sun-icon');
  const moonIcon = document.getElementById('moon-icon');
  const currentTheme = document.documentElement.getAttribute('data-theme');
  
  if (currentTheme === 'dark') {
    sunIcon.style.display = 'block';
    moonIcon.style.display = 'none';
  } else {
    sunIcon.style.display = 'none';
    moonIcon.style.display = 'block';
  }
}

// Toggle dark mode function
function toggleDarkMode() {
  const currentTheme = document.documentElement.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  
  document.documentElement.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  updateToggleButton();
}

// Initialize button on page load
document.addEventListener('DOMContentLoaded', updateToggleButton);
</script>

<!-- Visitor Analytics (Backend Data Collection) -->
<script>
(function() {
  'use strict';
  
  // 收集访客数据
  function collectVisitorData() {
    const data = {
      timestamp: new Date().toISOString(),
      url: window.location.href,
      referrer: document.referrer || 'direct',
      userAgent: navigator.userAgent,
      language: navigator.language,
      screen: {
        width: screen.width,
        height: screen.height,
        colorDepth: screen.colorDepth
      },
      viewport: {
        width: window.innerWidth,
        height: window.innerHeight
      },
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      sessionId: getSessionId(),
      pageTitle: document.title
    };
    
    // 获取IP地址和地理位置信息
    fetch('https://ipapi.co/json/')
      .then(response => response.json())
      .then(ipData => {
        data.ip = ipData.ip;
        data.city = ipData.city;
        data.region = ipData.region;
        data.country = ipData.country_name;
        data.countryCode = ipData.country_code;
        data.latitude = ipData.latitude;
        data.longitude = ipData.longitude;
        data.isp = ipData.org;
        
        // 发送数据到后端
        sendAnalytics(data);
      })
      .catch(() => {
        // 如果IP API失败，仍然发送基本数据
        sendAnalytics(data);
      });
  }
  
  // 生成或获取会话ID
  function getSessionId() {
    let sessionId = sessionStorage.getItem('visitor_session_id');
    if (!sessionId) {
      sessionId = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      sessionStorage.setItem('visitor_session_id', sessionId);
    }
    return sessionId;
  }
  
  // 发送分析数据
  function sendAnalytics(data) {
    // 使用GitHub Gist作为简单的数据存储（可选方案1）
    // 或者使用Google Sheets API（可选方案2）
    // 或者使用Firebase（可选方案3）
    
    // 方案1: 使用FormSpree等服务收集数据
    const formData = new FormData();
    formData.append('analytics_data', JSON.stringify(data));
    
    fetch('https://formspree.io/f/xpzvzjbk', {
      method: 'POST',
      body: formData,
      headers: {
        'Accept': 'application/json'
      }
    }).catch(() => {
      // 静默失败，不影响用户体验
    });
    
    // 方案2: 使用Google Analytics替代品 - Plausible (更隐私友好)
    if (window.plausible) {
      window.plausible('pageview', {
        props: {
          country: data.country,
          device: getDeviceType(),
          session: data.sessionId.substr(0, 8)
        }
      });
    }
  }
  
  // 检测设备类型
  function getDeviceType() {
    const width = window.innerWidth;
    if (width <= 768) return 'mobile';
    if (width <= 1024) return 'tablet';
    return 'desktop';
  }
  
  // 页面加载完成后收集数据
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', collectVisitorData);
  } else {
    collectVisitorData();
  }
  
  // 页面卸载时记录会话时长
  let startTime = Date.now();
  window.addEventListener('beforeunload', function() {
    const sessionDuration = Date.now() - startTime;
    if (sessionDuration > 1000) { // 只记录停留超过1秒的访问
      navigator.sendBeacon && navigator.sendBeacon('https://formspree.io/f/xpzvzjbk', 
        JSON.stringify({
          type: 'session_end',
          sessionId: getSessionId(),
          duration: sessionDuration,
          timestamp: new Date().toISOString()
        })
      );
    }
  });
  
})();
</script>

<!-- 主要的网站分析系统 -->
<script src="{{ '/assets/js/analytics.js' | relative_url }}" defer></script>

<!-- 可选：添加隐私友好的Plausible Analytics -->
<script defer data-domain="steven-zn.github.io" src="https://plausible.io/js/script.js"></script>

{% if site.head_scripts %}
  {% for script in site.head_scripts %}
    <script src="{{ script | relative_url }}"></script>
  {% endfor %}
{% endif %}